<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compositor - Furtherfield Tools</title>
    <link rel="stylesheet" href="../../shared/styles.css">
    <style>
        .compositor-workspace {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: var(--ff-spacing-lg);
        }

        .layers-panel {
            background: white;
            border-radius: var(--ff-radius-md);
            padding: var(--ff-spacing-lg);
            box-shadow: var(--ff-shadow-md);
            max-height: 600px;
            overflow-y: auto;
        }

        .layer {
            background: var(--ff-gray-50);
            border: 2px solid var(--ff-gray-200);
            border-radius: var(--ff-radius-sm);
            padding: var(--ff-spacing-sm);
            margin-bottom: var(--ff-spacing-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer:hover {
            border-color: var(--ff-secondary);
        }

        .layer.active {
            border-color: var(--ff-secondary);
            background: #e0f2fe;
        }

        .layer-preview {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: var(--ff-radius-sm);
            margin-bottom: var(--ff-spacing-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .layer-preview img,
        .layer-preview svg {
            max-width: 100%;
            max-height: 100%;
        }

        .layer-name {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: var(--ff-spacing-xs);
        }

        .layer-controls {
            display: flex;
            gap: var(--ff-spacing-xs);
            margin-top: var(--ff-spacing-xs);
        }

        .layer-btn {
            padding: var(--ff-spacing-xs) var(--ff-spacing-sm);
            border: 1px solid var(--ff-gray-300);
            background: white;
            border-radius: var(--ff-radius-sm);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .layer-btn:hover {
            background: var(--ff-gray-100);
        }

        .canvas-container {
            background: white;
            border-radius: var(--ff-radius-md);
            padding: var(--ff-spacing-lg);
            box-shadow: var(--ff-shadow-md);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 600px;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            background: #f0f0f0;
            box-shadow: var(--ff-shadow-lg);
        }

        #compositionCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .property-panel {
            background: white;
            border-radius: var(--ff-radius-md);
            padding: var(--ff-spacing-lg);
            box-shadow: var(--ff-shadow-md);
            margin-top: var(--ff-spacing-lg);
        }

        @media (max-width: 1024px) {
            .compositor-workspace {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="ff-container">
        <header class="ff-header">
            <h1>Compositor</h1>
            <p class="subtitle">Combine outputs from micro-apps into final compositions</p>
            <div class="app-nav">
                <a href="../../index.html">← Back to Apps</a>
                <a href="../grid-generator/index.html">Grid Generator</a>
                <a href="../colorist/index.html">Colorist</a>
                <a href="../sprite-generator/index.html">Sprite Generator</a>
                <a href="../mark-generator/index.html">Mark Generator</a>
            </div>
        </header>

        <div class="ff-card">
            <h3 style="margin-bottom: var(--ff-spacing-md); color: var(--ff-primary);">Add Layers</h3>
            <div class="ff-control-group">
                <input type="file" id="fileInput" accept=".svg,.png,.jpg,.jpeg" multiple class="ff-file-input">
                <label for="fileInput" class="ff-file-label">Add Assets (SVG, PNG, JPG)</label>
            </div>
            <div class="ff-control-group">
                <label for="bgColor">Background Color</label>
                <input type="color" id="bgColor" value="#ffffff">
            </div>
        </div>

        <div class="compositor-workspace">
            <div class="layers-panel">
                <h3 style="margin-bottom: var(--ff-spacing-md); color: var(--ff-primary);">Layers</h3>
                <div id="layersList"></div>
                <button class="ff-btn ff-btn-secondary" style="width: 100%; margin-top: var(--ff-spacing-md);" id="clearAllBtn">Clear All</button>
            </div>

            <div>
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="compositionCanvas" width="800" height="800"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="property-panel" id="propertyPanel" style="display: none;">
            <h3 style="margin-bottom: var(--ff-spacing-md); color: var(--ff-primary);">Layer Properties</h3>

            <div class="ff-control-group">
                <div class="ff-range-display">
                    <label for="layerX">X Position</label>
                    <span class="ff-range-value" id="layerXValue">0</span>
                </div>
                <input type="range" id="layerX" class="ff-range" min="-400" max="400" value="0">
            </div>

            <div class="ff-control-group">
                <div class="ff-range-display">
                    <label for="layerY">Y Position</label>
                    <span class="ff-range-value" id="layerYValue">0</span>
                </div>
                <input type="range" id="layerY" class="ff-range" min="-400" max="400" value="0">
            </div>

            <div class="ff-control-group">
                <div class="ff-range-display">
                    <label for="layerScale">Scale</label>
                    <span class="ff-range-value" id="layerScaleValue">100%</span>
                </div>
                <input type="range" id="layerScale" class="ff-range" min="10" max="200" value="100">
            </div>

            <div class="ff-control-group">
                <div class="ff-range-display">
                    <label for="layerOpacity">Opacity</label>
                    <span class="ff-range-value" id="layerOpacityValue">100%</span>
                </div>
                <input type="range" id="layerOpacity" class="ff-range" min="0" max="100" value="100">
            </div>

            <div class="ff-control-group">
                <div class="ff-range-display">
                    <label for="layerRotation">Rotation</label>
                    <span class="ff-range-value" id="layerRotationValue">0°</span>
                </div>
                <input type="range" id="layerRotation" class="ff-range" min="0" max="360" value="0">
            </div>
        </div>

        <div class="ff-card">
            <div class="ff-btn-group">
                <button class="ff-btn ff-btn-primary" id="renderBtn">Render Composition</button>
                <button class="ff-btn ff-btn-secondary" id="exportPNGBtn">Export PNG</button>
                <button class="ff-btn ff-btn-secondary" id="exportSVGBtn">Export SVG</button>
                <button class="ff-btn ff-btn-secondary" id="exportMetaBtn">Export Metadata</button>
            </div>
        </div>
    </div>

    <script src="../../shared/config.js"></script>
    <script src="../../shared/utils.js"></script>
    <script>
        // State
        let layers = [];
        let activeLayerIndex = null;
        const canvasSize = 800;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeControls();
            renderComposition();
        });

        function initializeControls() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            document.getElementById('bgColor').addEventListener('input', renderComposition);
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);

            // Property controls
            ['layerX', 'layerY', 'layerScale', 'layerOpacity', 'layerRotation'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', updateActiveLayer);
            });

            // Export buttons
            document.getElementById('renderBtn').addEventListener('click', renderComposition);
            document.getElementById('exportPNGBtn').addEventListener('click', exportPNG);
            document.getElementById('exportSVGBtn').addEventListener('click', exportSVG);
            document.getElementById('exportMetaBtn').addEventListener('click', exportMetadata);
        }

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);

            for (const file of files) {
                const layer = {
                    id: FurtherfieldUtils.generateId(),
                    name: file.name,
                    x: 0,
                    y: 0,
                    scale: 1,
                    opacity: 1,
                    rotation: 0,
                    type: file.type.startsWith('image/') ? 'image' : 'svg',
                    data: null
                };

                if (layer.type === 'image' || file.name.endsWith('.png') || file.name.match(/\.(jpg|jpeg)$/i)) {
                    layer.data = await FurtherfieldUtils.loadImage(file);
                    layer.type = 'image';
                } else if (file.name.endsWith('.svg')) {
                    layer.data = await FurtherfieldUtils.loadSVG(file);
                    layer.type = 'svg';
                }

                layers.push(layer);
            }

            updateLayersList();
            renderComposition();
        }

        function updateLayersList() {
            const list = document.getElementById('layersList');
            list.innerHTML = '';

            layers.forEach((layer, index) => {
                const layerEl = document.createElement('div');
                layerEl.className = 'layer';
                if (index === activeLayerIndex) layerEl.classList.add('active');

                const preview = document.createElement('div');
                preview.className = 'layer-preview';

                if (layer.type === 'image') {
                    const img = document.createElement('img');
                    img.src = layer.data;
                    preview.appendChild(img);
                } else {
                    const svg = layer.data.cloneNode(true);
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    preview.appendChild(svg);
                }

                const name = document.createElement('div');
                name.className = 'layer-name';
                name.textContent = layer.name;

                const controls = document.createElement('div');
                controls.className = 'layer-controls';

                const upBtn = document.createElement('button');
                upBtn.className = 'layer-btn';
                upBtn.textContent = '↑';
                upBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveLayer(index, -1);
                };

                const downBtn = document.createElement('button');
                downBtn.className = 'layer-btn';
                downBtn.textContent = '↓';
                downBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveLayer(index, 1);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'layer-btn';
                deleteBtn.textContent = '×';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteLayer(index);
                };

                controls.appendChild(upBtn);
                controls.appendChild(downBtn);
                controls.appendChild(deleteBtn);

                layerEl.appendChild(preview);
                layerEl.appendChild(name);
                layerEl.appendChild(controls);

                layerEl.onclick = () => selectLayer(index);

                list.appendChild(layerEl);
            });
        }

        function selectLayer(index) {
            activeLayerIndex = index;
            const layer = layers[index];

            // Update property panel
            document.getElementById('layerX').value = layer.x;
            document.getElementById('layerXValue').textContent = layer.x;
            document.getElementById('layerY').value = layer.y;
            document.getElementById('layerYValue').textContent = layer.y;
            document.getElementById('layerScale').value = layer.scale * 100;
            document.getElementById('layerScaleValue').textContent = `${Math.round(layer.scale * 100)}%`;
            document.getElementById('layerOpacity').value = layer.opacity * 100;
            document.getElementById('layerOpacityValue').textContent = `${Math.round(layer.opacity * 100)}%`;
            document.getElementById('layerRotation').value = layer.rotation;
            document.getElementById('layerRotationValue').textContent = `${layer.rotation}°`;

            document.getElementById('propertyPanel').style.display = 'block';
            updateLayersList();
        }

        function updateActiveLayer() {
            if (activeLayerIndex === null) return;

            const layer = layers[activeLayerIndex];
            layer.x = parseInt(document.getElementById('layerX').value);
            layer.y = parseInt(document.getElementById('layerY').value);
            layer.scale = parseFloat(document.getElementById('layerScale').value) / 100;
            layer.opacity = parseFloat(document.getElementById('layerOpacity').value) / 100;
            layer.rotation = parseInt(document.getElementById('layerRotation').value);

            document.getElementById('layerXValue').textContent = layer.x;
            document.getElementById('layerYValue').textContent = layer.y;
            document.getElementById('layerScaleValue').textContent = `${Math.round(layer.scale * 100)}%`;
            document.getElementById('layerOpacityValue').textContent = `${Math.round(layer.opacity * 100)}%`;
            document.getElementById('layerRotationValue').textContent = `${layer.rotation}°`;

            renderComposition();
        }

        function moveLayer(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= layers.length) return;

            [layers[index], layers[newIndex]] = [layers[newIndex], layers[index]];

            if (activeLayerIndex === index) {
                activeLayerIndex = newIndex;
            } else if (activeLayerIndex === newIndex) {
                activeLayerIndex = index;
            }

            updateLayersList();
            renderComposition();
        }

        function deleteLayer(index) {
            layers.splice(index, 1);
            if (activeLayerIndex === index) {
                activeLayerIndex = null;
                document.getElementById('propertyPanel').style.display = 'none';
            } else if (activeLayerIndex > index) {
                activeLayerIndex--;
            }
            updateLayersList();
            renderComposition();
        }

        function clearAll() {
            if (confirm('Clear all layers?')) {
                layers = [];
                activeLayerIndex = null;
                document.getElementById('propertyPanel').style.display = 'none';
                updateLayersList();
                renderComposition();
            }
        }

        function renderComposition() {
            const canvas = document.getElementById('compositionCanvas');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvasSize, canvasSize);

            // Fill background
            ctx.fillStyle = document.getElementById('bgColor').value;
            ctx.fillRect(0, 0, canvasSize, canvasSize);

            // Render each layer
            layers.forEach(layer => {
                ctx.save();

                // Apply transformations
                ctx.translate(canvasSize / 2 + layer.x, canvasSize / 2 + layer.y);
                ctx.rotate(layer.rotation * Math.PI / 180);
                ctx.scale(layer.scale, layer.scale);
                ctx.globalAlpha = layer.opacity;

                if (layer.type === 'image') {
                    const img = new Image();
                    img.src = layer.data;
                    img.onload = () => {
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    };
                    // For already loaded images
                    if (img.complete) {
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    }
                } else {
                    // Render SVG to canvas
                    const svgData = new XMLSerializer().serializeToString(layer.data);
                    const img = new Image();
                    img.onload = () => {
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                    };
                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                }

                ctx.restore();
            });
        }

        function exportPNG() {
            const canvas = document.getElementById('compositionCanvas');
            const filename = FurtherfieldUtils.generateFilename('composition', 'png');

            canvas.toBlob(blob => {
                FurtherfieldUtils.downloadBlob(blob, filename);
            });
        }

        function exportSVG() {
            // Create SVG from layers
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', canvasSize);
            svg.setAttribute('height', canvasSize);
            svg.setAttribute('viewBox', `0 0 ${canvasSize} ${canvasSize}`);

            // Background
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', canvasSize);
            bg.setAttribute('height', canvasSize);
            bg.setAttribute('fill', document.getElementById('bgColor').value);
            svg.appendChild(bg);

            // Add layers
            layers.forEach(layer => {
                if (layer.type === 'svg') {
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const centerX = canvasSize / 2;
                    const centerY = canvasSize / 2;

                    g.setAttribute('transform', `translate(${centerX + layer.x}, ${centerY + layer.y}) rotate(${layer.rotation}) scale(${layer.scale})`);
                    g.setAttribute('opacity', layer.opacity);

                    const clone = layer.data.cloneNode(true);
                    Array.from(clone.children).forEach(child => {
                        g.appendChild(child.cloneNode(true));
                    });

                    svg.appendChild(g);
                }
            });

            const metadata = FurtherfieldUtils.createMetadata('compositor', 'composition', ['layered']);
            const filename = FurtherfieldUtils.generateFilename('composition', 'svg');
            FurtherfieldUtils.exportSVG(svg, filename, metadata);
        }

        function exportMetadata() {
            const metadata = FurtherfieldUtils.createMetadata('compositor', 'composition', ['layered']);
            metadata.layers = layers.map(layer => ({
                name: layer.name,
                x: layer.x,
                y: layer.y,
                scale: layer.scale,
                opacity: layer.opacity,
                rotation: layer.rotation
            }));

            const filename = FurtherfieldUtils.generateFilename('composition-metadata', 'json');
            FurtherfieldUtils.exportJSON(metadata, filename);
        }
    </script>
</body>
</html>
